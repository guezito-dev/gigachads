// vouches-widget.js
const DEBUG_MODE = true;
const MAX_ITEMS = 5;
const GITHUB_JSON_URL = 'https://raw.githubusercontent.com/guezito-dev/gigachads/main/gigachads-ranking.json';

let gigachadsData = null;
const processedActivities = new Set();

function debug(message, data = null) {
    if (DEBUG_MODE) {
        console.log(`[VOUCHES] ${message}`, data);
    }
}

function showError(message, details = null) {
    console.error('[ERROR]', message, details);
    document.getElementById('loading').style.display = 'none';
    const errorEl = document.getElementById('error');
    errorEl.style.display = 'block';
    
    // CORRECTION : G√©rer le cas o√π message est un objet
    let errorMessage = message;
    if (typeof message === 'object' && message !== null) {
        errorMessage = message.message || message.toString() || 'An error occurred';
    }
    
    errorEl.innerHTML = `<div class="error">${errorMessage}</div>`;
}

function getVouchAmount(activity) {
    if (activity.content?.stakeAmount) {
        return parseFloat(activity.content.stakeAmount);
    }
    if (activity.content?.amount) {
        return parseFloat(activity.content.amount);
    }
    if (activity.content?.value) {
        return parseFloat(activity.content.value);
    }
    
    return 0;
}

function getVouchTitle(activity) {
    const amount = getVouchAmount(activity);
    const subjectName = activity.subjectUser?.displayName || activity.subjectUser?.username || 'User';
    
    if (amount > 0) {
        return `Vouch for ${subjectName} (${amount.toFixed(4)} ETH)`;
    }
    
    return `Vouch for ${subjectName}`;
}

function createUniqueId(activity) {
    const authorId = activity.author?.profileId || activity.authorUser?.profileId;
    const subjectId = activity.subject?.profileId || activity.subjectUser?.profileId;
    const timestamp = activity.timestamp || activity.createdAt;
    
    return `${authorId}-${subjectId}-${timestamp}`;
}

function createVouchHTML(activity) {
    const author = activity.authorUser || activity.author;
    const subject = activity.subjectUser || activity.subject;
    const amount = getVouchAmount(activity);
    
    const authorName = author?.displayName || author?.username || 'Unknown';
    const subjectName = subject?.displayName || subject?.username || 'Unknown';
    const authorAvatar = author?.pfp?.url || author?.avatar || 'https://via.placeholder.com/32';
    const subjectAvatar = subject?.pfp?.url || subject?.avatar || 'https://via.placeholder.com/32';
    
    const authorCredScore = author?.credibilityScore || 0;
    const subjectCredScore = subject?.credibilityScore || 0;
    
    const authorBadges = getCredibilityBadges(authorCredScore);
    const subjectBadges = getCredibilityBadges(subjectCredScore);
    
    const amountDisplay = amount > 0 ? ` (${amount.toFixed(4)} ETH)` : '';
    
    return `
        <div class="activity-item">
            <div class="user-info">
                <img src="${authorAvatar}" alt="${authorName}" class="avatar">
                <span class="username">${authorName}</span>
                ${authorBadges}
            </div>
            <div class="arrow">‚Üí</div>
            <div class="user-info">
                <img src="${subjectAvatar}" alt="${subjectName}" class="avatar">
                <span class="username">${subjectName}</span>
                ${subjectBadges}
            </div>
            <div class="activity-title">
                <p>Vouch for ${subjectName}${amountDisplay}</p>
            </div>
        </div>
    `;
}

function getCredibilityBadges(score) {
    let badges = '';
    
    if (score >= 100) {
        badges += '<span class="badge gigachad">üèÜ</span>';
    }
    if (score >= 50) {
        badges += '<span class="badge verified">‚úÖ</span>';
    }
    if (score >= 25) {
        badges += '<span class="badge trusted">üîí</span>';
    }
    
    return badges;
}

function getTimestamp(activity) {
    const timestamp = activity.timestamp || activity.createdAt;
    if (!timestamp) return 'Unknown time';
    
    const date = new Date(timestamp);
    const now = new Date();
    const diffInSeconds = Math.floor((now - date) / 1000);
    
    if (diffInSeconds < 60) return 'Just now';
    if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
    if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
    if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
    
    return date.toLocaleDateString();
}

function isGigachad(user) {
    if (!gigachadsData || !user) return false;
    
    const profileId = user.profileId || user.id;
    const username = user.username || user.displayName;
    
    return gigachadsData.some(gigachad => 
        gigachad.profileId === profileId || 
        gigachad.username === username
    );
}

function filterVouches(activities) {
    debug('Filtering vouches from activities', { totalActivities: activities.length });
    
    const vouches = activities.filter(activity => {
        if (activity.type !== 'vouch') return false;
        
        const author = activity.authorUser || activity.author;
        const subject = activity.subjectUser || activity.subject;
        
        if (!author || !subject) return false;
        
        const authorIsGigachad = isGigachad(author);
        const subjectIsGigachad = isGigachad(subject);
        
        return authorIsGigachad && subjectIsGigachad;
    });
    
    debug('Filtered vouches', { vouchCount: vouches.length });
    return vouches;
}

function removeDuplicates(activities) {
    const seen = new Set();
    const unique = [];
    
    for (const activity of activities) {
        const id = createUniqueId(activity);
        if (!seen.has(id)) {
            seen.add(id);
            unique.push(activity);
        }
    }
    
    debug('Removed duplicates', { before: activities.length, after: unique.length });
    return unique;
}

function sortByTimestamp(activities) {
    return activities.sort((a, b) => {
        const aTime = new Date(a.timestamp || a.createdAt || 0);
        const bTime = new Date(b.timestamp || b.createdAt || 0);
        return bTime - aTime;
    });
}

function displayVouches(vouches) {
    const vouchesList = document.getElementById('vouchesList');
    
    if (vouches.length > 0) {
        vouchesList.innerHTML = vouches.map(createVouchHTML).join('');
    } else {
        vouchesList.innerHTML = '<div class="empty-state"><p>No recent vouches found between Giga Chads</p></div>';
    }
}

async function loadFromGitHub() {
    try {
        debug('Loading from GitHub', GITHUB_JSON_URL);
        const response = await fetch(GITHUB_JSON_URL);
        
        if (!response.ok) {
            throw new Error(`GitHub fetch failed: ${response.status}`);
        }
        
        const data = await response.json();
        gigachadsData = data;
        debug('GitHub data loaded successfully', { gigachadsCount: data.length });
        return true;
    } catch (error) {
        debug('GitHub loading failed', error);
        return false;
    }
}

async function loadVouches() {
    try {
        if (!gigachadsData) {
            throw new Error('No Gigachads data available');
        }
        
        debug('Processing Gigachads data', { count: gigachadsData.length });
        
        let allActivities = [];
        
        for (const gigachad of gigachadsData) {
            if (gigachad.activities && Array.isArray(gigachad.activities)) {
                allActivities = allActivities.concat(gigachad.activities);
            }
        }
        
        debug('All activities collected', { count: allActivities.length });
        
        if (allActivities.length === 0) {
            displayVouches([]);
            return;
        }
        
        const vouches = filterVouches(allActivities);
        const uniqueVouches = removeDuplicates(vouches);
        const sortedVouches = sortByTimestamp(uniqueVouches);
        const recentVouches = sortedVouches.slice(0, MAX_ITEMS);
        
        debug('Final vouches to display', { count: recentVouches.length });
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        
        displayVouches(recentVouches);
        
    } catch (error) {
        debug('Error in loadVouches', error);
        showError('Failed to load vouches data');
    }
}

function handleManualInput() {
    const textarea = document.getElementById('jsonInput');
    const jsonText = textarea.value.trim();
    
    if (!jsonText) {
        showError('Please paste your JSON data');
        return;
    }
    
    try {
        const data = JSON.parse(jsonText);
        gigachadsData = data;
        debug('Manual data loaded', { count: data.length });
        
        document.getElementById('localTesting').style.display = 'none';
        loadVouches();
        
    } catch (error) {
        showError('Invalid JSON format. Please check your data.');
    }
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', async function() {
    debug('Page loaded, starting initialization');
    
    // Try GitHub first, then local file, then show manual input
    const githubSuccess = await loadFromGitHub();
    
    if (githubSuccess) {
        await loadVouches();
    } else {
        try {
            const response = await fetch('gigachads-ranking.json');
            if (response.ok) {
                gigachadsData = await response.json();
                await loadVouches();
            } else {
                throw new Error('Local JSON file not found');
            }
        } catch (error) {
            debug('Auto-loading failed', error);
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            showError('Auto-loading failed. Please use manual input below.');
        }
    }
});
